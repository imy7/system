name: æ›´æ–°ä»£ç†IPæ•°æ®

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤© UTC æ—¶é—´ 00:00ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install requests

      - name: è¿è¡Œæ•°æ®è·å–è„šæœ¬
        run: |
          python << 'EOF'
          import requests
          import os

          # ç¡®ä¿ cmliu ç›®å½•å­˜åœ¨
          os.makedirs("cmliu", exist_ok=True)

          # ============ è·å–å¹¶å†™å…¥ cmliu/proxy.txt ============
          proxy_url = "https://ipdb.api.030101.xyz/?type=bestproxy&country=true"
          proxy_file = "cmliu/proxy.txt"

          try:
              resp = requests.get(proxy_url, timeout=10)
              resp.raise_for_status()
              data = resp.json()
              with open(proxy_file, "w", encoding="utf-8") as f:
                  for item in data:
                      ip = item.get("ip")
                      country = item.get("country", "unknown").upper()[:2]  # å›½å®¶ä»£ç å‰ä¸¤ä½
                      if ip:
                          f.write(f"{ip}#{country}\n")
              print(f"âœ… {proxy_file} æ›´æ–°å®Œæˆ")
          except Exception as e:
              print(f"âŒ è·å– {proxy_url} å¤±è´¥: {e}")
              open(proxy_file, "w").close()  # æ¸…ç©ºæˆ–åˆ›å»ºç©ºæ–‡ä»¶


          # ============ è·å–å¹¶å†™å…¥ cmliu/ipv4.txt ============
          ipv4_urls = [
              "https://addressesapi.090227.xyz/ip.164746.xyz",
              "https://addressesapi.090227.xyz/CloudFlareYes",
              "https://ipdb.api.030101.xyz/?type=bestcf&country=true"
          ]
          ipv4_file = "cmliu/ipv4.txt"

          lines = set()  # ä½¿ç”¨ set å»é‡

          for url in ipv4_urls:
              try:
                  headers = {"User-Agent": "curl/7.68.0"}
                  resp = requests.get(url, timeout=10, headers=headers)
                  resp.raise_for_status()

                  if "ipdb.api" in url:
                      # JSON æ ¼å¼ï¼šåŒ…å« country
                      data = resp.json()
                      for item in data:
                          ip = item.get("ip")
                          country = item.get("country", "unknown").upper()[:2]
                          if ip:
                              lines.add(f"{ip}#{country}")
                  else:
                      # çº¯æ–‡æœ¬ IP åˆ—è¡¨ï¼ˆå¦‚ ip.164746.xyz å’Œ CloudFlareYesï¼‰
                      for line in resp.text.strip().splitlines():
                          ip = line.strip()
                          if ip and "." in ip:  # ç¡®ä¿æ˜¯ IPv4
                              lines.add(f"{ip}#US")  # é»˜è®¤å›½å®¶ç  USï¼ˆå¯è‡ªå®šä¹‰ï¼‰
              except Exception as e:
                  print(f"âš ï¸ è·å– {url} å¤±è´¥: {e}")

          # å†™å…¥æ–‡ä»¶ï¼ˆè¦†ç›–åŸå†…å®¹ï¼‰
          with open(ipv4_file, "w", encoding="utf-8") as f:
              for line in sorted(lines):
                  f.write(line + "\n")
          print(f"âœ… {ipv4_file} æ›´æ–°å®Œæˆ")

          EOF

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"

          # æ·»åŠ  cmliu ç›®å½•ä¸‹çš„æ–‡ä»¶
          git add cmliu/proxy.txt cmliu/ipv4.txt

          # åˆ¤æ–­æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
            echo "âœ… æ²¡æœ‰æ›´æ”¹ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–° IP æ•°æ® $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "ğŸ‰ æ•°æ®å·²æäº¤å¹¶æ¨é€åˆ°ä»“åº“"
          fi
